import{d as w,r as Z,w as k}from"./entry.XbCZtbrv.js";import{p as h}from"./stores.zceJZ__p.js";import{t as y}from"./translate.HrioCK44.js";import{v as V,z as E}from"./scheduler.LRpOgQOC.js";import{r as d,a as u,b as oo,p as to,c as no,d as ro,e as eo}from"./route-for-api.rPK9t_O_.js";import{A as p}from"./workflow-actions.-K4W_iAA.js";import{h as so}from"./decode-payload.Zcnhu9OM.js";import{f as ao}from"./screaming-enums.NBZzZ07O.js";import{w as io}from"./write-actions-are-allowed.2p9dgOO1.js";import{s as co}from"./simplify-attributes.hEv8Z9Aw.js";import{a as Q}from"./auth-user.UIpnvKPu.js";import{i as N,m as z}from"./version-check.HLZIw2tw.js";import{c as U,t as W}from"./versions.1soxX9lo.js";import{q as fo,s as uo}from"./filters.o5vo-gbm.js";import{e as lo}from"./encode-payload.MjIx1Gzw.js";import{s as T}from"./parse-with-big-int.e3oI4SEy.js";import{k as wo,l as mo,m as q,n as ko}from"./format-time.wvxl6IWV.js";import{v as yo}from"./toaster.ES5mncZo.js";const ho=async(o,t,n=fetch)=>{let r=0;try{const e=d("workflows.count",{namespace:o}),s=await u(e,{params:t?{query:t}:{},onError:V,handleError:V,request:n});r=parseInt((s==null?void 0:s.count)||"0")}catch{}return{count:r}},ct=async({namespace:o,query:t})=>{const n="GROUP BY ExecutionStatus",r=d("workflows.count",{namespace:o}),{count:e,groups:s}=await u(r,{params:{query:t?`${t} ${n}`:`${n}`},notifyOnError:!1});return{count:e??"0",groups:s}},Eo=(o=[])=>o.map(t=>{const n=co(t,!0),r=t.activityId;return{...n,id:r}}),po=o=>!o||!o.indexedFields?{}:{indexedFields:Object.entries(o.indexedFields).reduce((n,[r,e])=>({...n,[r]:so(e)}),{})},S=o=>{var R,P,v,O,$,B,F;const t=po(o.workflowExecutionInfo.searchAttributes),n=o.workflowExecutionInfo.memo,r=o.workflowExecutionInfo.type.name,e=o.workflowExecutionInfo.execution.workflowId,s=o.workflowExecutionInfo.execution.runId,a=o.workflowExecutionInfo.startTime,i=o.workflowExecutionInfo.closeTime,l=o.workflowExecutionInfo.executionTime,f=ao(o.workflowExecutionInfo.status),m=f==="Running",g=o.workflowExecutionInfo.historyLength,c=o.workflowExecutionInfo.historySizeBytes,x=`/workflows/${e}/${s}`,I=((P=(R=o==null?void 0:o.executionConfig)==null?void 0:R.taskQueue)==null?void 0:P.name)||((v=o==null?void 0:o.workflowExecutionInfo)==null?void 0:v.taskQueue),G=(O=o==null?void 0:o.workflowExecutionInfo)==null?void 0:O.mostRecentWorkerVersionStamp,_=($=o==null?void 0:o.workflowExecutionInfo)==null?void 0:$.parentNamespaceId,Y=(B=o==null?void 0:o.workflowExecutionInfo)==null?void 0:B.parentExecution,H=o.workflowExecutionInfo.stateTransitionCount,J=(F=o.executionConfig)==null?void 0:F.defaultWorkflowTaskTimeout,M=Eo(o.pendingActivities),X=(o==null?void 0:o.pendingChildren)??[];return{name:r,id:e,runId:s,startTime:a,endTime:i,executionTime:l,status:f,historyEvents:g,historySizeBytes:c,searchAttributes:t,memo:n,url:x,taskQueue:I,mostRecentWorkerVersionStamp:G,pendingActivities:M,pendingChildren:X,parentNamespaceId:_,parent:Y,stateTransitionCount:H,isRunning:m,defaultWorkflowTaskTimeout:J,get canBeTerminated(){return m&&io()}}},L=o=>(o.executions||[]).map(t=>S({workflowExecutionInfo:t})),xo=(o,t)=>{var n;return((n=o==null?void 0:o.visibilityStore)==null?void 0:n.includes("elasticsearch"))||N(t,"1.19")},Io=o=>{var t;return(t=o==null?void 0:o.visibilityStore)==null?void 0:t.includes("elasticsearch")},A=w([h],([o])=>{var t,n,r;return(r=(n=(t=o.data)==null?void 0:t.settings)==null?void 0:n.runtimeEnvironment)==null?void 0:r.isCloud}),j=w([U,W,A],([o,t,n])=>xo(o,t)||n);w([U,A],([o,t])=>Io(o)||t);const go={workflowId:"WorkflowId",workflowType:"WorkflowType",timeRange:"StartTime",executionStatus:"ExecutionStatus",closeTime:"CloseTime"},bo=["workflowId","workflowType","timeRange","executionStatus","closeTime"],Wo=o=>!(o===null||o===void 0||o===""||typeof o=="string"&&o==="undefined"),To=o=>{if(typeof o!="string")return!1;for(const t of bo)if(t===o)return!0;return!1},So=(o,t,n)=>{const r=go[o];return t==="All"?"":wo(t)||mo(t)?n||E(j)?`${r} > "${q(t)}"`:`${r} BETWEEN "${q(t)}" AND "${ko()}"`:`${r}="${t}"`},Ao=(o,t)=>Object.entries(o).map(([n,r])=>{if(To(n)&&Wo(r))return So(n,r,t)}).filter(Boolean),Co=(o,t=!1)=>Ao(o,t).join(" and ");function Ro(o){console.error("Unhandled action:",o)}const Po=(o,t)=>{let n;switch(o){case p.Cancel:n=y("workflows.canceled");break;case p.Reset:n=y("workflows.reset");break;case p.Terminate:n=y("workflows.terminated");break;default:Ro(o)}return t?y("workflows.workflow-action-reason-placeholder-with-email",{action:n,email:t}):y("workflows.workflow-action-reason-placeholder",{action:n})},D=({action:o,reason:t,email:n})=>{const r=Po(o,n);return t?[t.trim(),r].join(" "):r},C=async(o,t,n=fetch,r=!1)=>{const e=t.query||Co(t,r);let s;try{s=decodeURIComponent(e)}catch{s=e}const a=r?"workflows.archived":"workflows";let i="";const l=c=>{var x,I;no(c),(x=c==null?void 0:c.body)!=null&&x.message||c!=null&&c.status?i=((I=c==null?void 0:c.body)==null?void 0:I.message)??`Error fetching workflows: ${c.status}: ${c.statusText}`:i="Error fetching workflows: Server failed to respond"},f=d(a,{namespace:o}),{executions:m,nextPageToken:g}=await u(f,{params:{query:s},onError:l,handleError:l,request:n})??{executions:[],nextPageToken:""};return{workflows:L({executions:m}),nextPageToken:String(g),error:i}},ft=async({namespace:o,workflowId:t,url:n},r=fetch)=>{var m;const e="workflows",s=n??oo(o),a=to(e,{namespace:o}),i=s+a,{executions:l}=await u(i,{params:{query:`WorkflowId="${t}"`,pageSize:"1"},request:r})??{executions:[]},f=(m=L({executions:l}))==null?void 0:m[0];return{runId:f==null?void 0:f.runId}},ut=async(o,t=fetch,n=!1)=>{const r=n?"workflows.archived":"workflows";let e=!0;const s=i=>{(ro(i)||eo(i))&&(e=!1)},a=d(r,{namespace:o});return await u(a,{params:{pageSize:"1"},onError:s,handleError:s,request:t}),{authorized:e}},lt=async(o,t,n=fetch)=>C(o,t,n,!0);async function wt(o,t=fetch){const n=d("workflow",{namespace:o.namespace,workflowId:o.workflowId});return u(n,{request:t,notifyOnError:!1,params:{"execution.runId":o.runId}}).then(r=>({workflow:S(r)})).catch(r=>({error:r}))}async function dt({workflow:o,namespace:t,reason:n}){const r=d("workflow.terminate",{namespace:t,workflowId:o.id}),e=E(Q).email,s=D({reason:n,action:p.Terminate,email:e});return await u(r,{options:{method:"POST",body:T({reason:s,...e&&{identity:e}})},notifyOnError:!1,params:{"execution.runId":o.runId}})}async function mt({namespace:o,workflow:{id:t,runId:n}},r=fetch){const e=d("workflow.cancel",{namespace:o,workflowId:t});return u(e,{request:r,notifyOnError:!1,options:{method:"POST"},params:{"execution.runId":n}})}async function kt({namespace:o,workflow:{id:t,runId:n},name:r,input:e}){const s=d("workflow.signal",{namespace:o,workflowId:t,signalName:r}),a=await lo(e),i=E(h).data.settings,l=(i==null?void 0:i.version)??"",m=N(l,"2.22")?{signalName:r,workflowExecution:{workflowId:t,runId:n},input:{payloads:a}}:{signalName:r,input:{payloads:a},params:{"execution.runId":n}};return u(s,{notifyOnError:!1,options:{method:"POST",body:T(m)}})}async function yt({namespace:o,workflow:{id:t,runId:n},eventId:r,reason:e,reapplyType:s}){const a=d("workflow.reset",{namespace:o,workflowId:t}),i=E(Q).email,l=D({action:p.Reset,reason:e,email:i}),f={workflowExecution:{workflowId:t,runId:n},workflowTaskFinishEventId:r,resetReapplyType:s,requestId:yo(),reason:l};return u(a,{notifyOnError:!1,options:{method:"POST",body:T(f)},params:{"execution.runId":n}})}async function ht(o,t=fetch){const n=e=>{console.error(e)},r=d("workflow",o);return u(r,{request:t,onError:n,handleError:n}).then(S)}async function Et(o,t){if(!E(K))return[];try{const{workflows:n}=await C(o,{query:`ParentWorkflowId = "${t}"`});return n}catch{return[]}}const vo=300,Oo=async(o,t,n)=>{t.set(!0);try{await n()}catch(r){console.error(r)}o.set(!1),setTimeout(()=>{t.set(!1)},vo)},$o=w([h],([o])=>{var t,n,r;return!!((r=(n=(t=o.data)==null?void 0:t.systemInfo)==null?void 0:n.capabilities)!=null&&r.countGroupByExecutionStatus)}),pt=w([h,W],([o,t])=>{var e,s,a;const n=z("1.23.0",t),r=!!((a=(s=(e=o.data)==null?void 0:e.systemInfo)==null?void 0:s.capabilities)!=null&&a.prefixSearch);return n||r}),Bo=k(0),Fo=w([h],([o])=>{var t,n;return(n=(t=o.data)==null?void 0:t.settings)==null?void 0:n.hideWorkflowQueryErrors}),K=w([A,W],([o,t])=>o||z("1.23",t)),Vo=w([fo,K,uo],([o,t,n])=>t&&!n?o?`ParentWorkflowId is NULL AND ${o}`:"ParentWorkflowId is NULL":o),qo=w([h],([o])=>o.params.namespace),Qo=w([qo,Vo,Bo,j,Fo],([o,t,n,r,e])=>({namespace:o,query:t,refresh:n,supportsAdvancedVisibility:r,hideWorkflowQueryErrors:e})),No=o=>{jo.set({...o,newCount:0})},zo=o=>Qo.subscribe(({namespace:t,query:n,supportsAdvancedVisibility:r,hideWorkflowQueryErrors:e})=>{Oo(Lo,Uo,async()=>{const{workflows:s,error:a}=await C(t,{query:n});if(o(s),r&&!E($o)){const i=await ho(t,n);No(i)}a?e?b.set(y("workflows.workflows-error-querying")):b.set(a):b.set("")})}),xt=k(""),Uo=k(!0),Lo=k(!0),jo=k({count:0,newCount:0}),b=k(""),It=Z([],zo),gt=k("");export{b as A,ut as a,Et as b,mt as c,lt as d,Co as e,ft as f,ct as g,xt as h,yt as i,wt as j,ht as k,$o as l,gt as m,Po as n,A as o,j as p,Vo as q,Bo as r,kt as s,dt as t,pt as u,K as v,jo as w,It as x,Lo as y,Uo as z};
